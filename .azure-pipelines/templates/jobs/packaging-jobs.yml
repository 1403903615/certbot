jobs:
  - job: installer_build
    pool:
      vmImage: vs2017-win2016
    steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: 3.7
          architecture: x86
          addToPath: true
      - script: python windows-installer/construct.py
        displayName: Build Certbot installer
      - task: CopyFiles@2
        inputs:
          sourceFolder: $(System.DefaultWorkingDirectory)/windows-installer/build/nsis
          contents: '*.exe'
          targetFolder: $(Build.ArtifactStagingDirectory)
      - task: PublishPipelineArtifact@1
        inputs:
          path: $(Build.ArtifactStagingDirectory)
          artifact: windows-installer
        displayName: Publish Windows installer
  - job: installer_run
    dependsOn: installer_build
    strategy:
      matrix:
        win2019:
          imageName: windows-2019
        win2016:
          imageName: vs2017-win2016
    pool:
      vmImage: $(imageName)
    steps:
      - powershell: |
          if ($PSVersionTable.PSVersion.Major -ne 5) {
              throw "Powershell version is not 5.x"
          }
        condition: eq(variables['imageName'], 'vs2017-win2016')
        displayName: Check Powershell 5.x is used in vs2017-win2016
      - task: UsePythonVersion@0
        inputs:
          versionSpec: 3.8
          addToPath: true
      - task: DownloadPipelineArtifact@2
        inputs:
          artifact: windows-installer
          path: $(Build.SourcesDirectory)/bin
        displayName: Retrieve Windows installer
      - script: |
          py -3 -m venv venv
          venv\Scripts\python tools\pip_install.py -e certbot-ci
        displayName: Prepare Certbot-CI
      - script: |
          set PATH=%ProgramFiles(x86)%\Certbot\bin;%PATH%
          venv\Scripts\python -m pytest certbot-ci\windows_installer_integration_tests --allow-persistent-changes --installer-path $(Build.SourcesDirectory)\bin\certbot-beta-installer-win32.exe
        displayName: Run windows installer integration tests
      - script: |
          set PATH=%ProgramFiles(x86)%\Certbot\bin;%PATH%
          venv\Scripts\python -m pytest certbot-ci\certbot_integration_tests\certbot_tests -n 4
        displayName: Run certbot integration tests
  - job: snap_build
    strategy:
      matrix:
        amd64:
          ARCH: amd64
        # Do not run the QEMU jobs for test branches
        ${{ if not(startsWith(variables['Build.SourceBranchName'], 'test-')) }}:
          arm64:
            ARCH: arm64
          armhf:
            ARCH: armhf
    pool:
      vmImage: ubuntu-18.04
    steps:
      - script: |
          tools/snap/build.sh ${ARCH}
          mv *.snap $(Build.ArtifactStagingDirectory)
        displayName: Build Certbot snap
      - task: PublishPipelineArtifact@1
        inputs:
          path: $(Build.ArtifactStagingDirectory)
          artifact: snap-$(arch)
        displayName: Store snap artifact
  - job: snap_dns_build
    strategy:
      matrix:
        amd64-certbot-dns-cloudflare:
          ARCH: amd64
          DNS_PLUGIN: certbot-dns-cloudflare
        amd64-certbot-dns-cloudxns:
          ARCH: amd64
          DNS_PLUGIN: certbot-dns-cloudxns
        amd64-certbot-dns-digitalocean:
          ARCH: amd64
          DNS_PLUGIN: certbot-dns-digitalocean
        amd64-certbot-dns-dnsimple:
          ARCH: amd64
          DNS_PLUGIN: certbot-dns-dnsimple
        amd64-certbot-dns-dnsmadeeasy:
          ARCH: amd64
          DNS_PLUGIN: certbot-dns-dnsmadeeasy
        amd64-certbot-dns-gehirn:
          ARCH: amd64
          DNS_PLUGIN: certbot-dns-gehirn
        amd64-certbot-dns-google:
          ARCH: amd64
          DNS_PLUGIN: certbot-dns-google
        amd64-certbot-dns-linode:
          ARCH: amd64
          DNS_PLUGIN: certbot-dns-linode
        amd64-certbot-dns-luadns:
          ARCH: amd64
          DNS_PLUGIN: certbot-dns-luadns
        amd64-certbot-dns-nsone:
          ARCH: amd64
          DNS_PLUGIN: certbot-dns-nsone
        amd64-certbot-dns-ovh:
          ARCH: amd64
          DNS_PLUGIN: certbot-dns-ovh
        amd64-certbot-dns-rfc2136:
          ARCH: amd64
          DNS_PLUGIN: certbot-dns-rfc2136
        amd64-certbot-dns-route53:
          ARCH: amd64
          DNS_PLUGIN: certbot-dns-route53
        amd64-certbot-dns-sakuracloud:
          ARCH: amd64
          DNS_PLUGIN: certbot-dns-sakuracloud
        # Do not run the QEMU jobs for test branches
        ${{ if not(startsWith(variables['Build.SourceBranchName'], 'test-')) }}:
          arm64-certbot-dns-cloudflare:
            ARCH: arm64
            DNS_PLUGIN: certbot-dns-cloudflare
          arm64-certbot-dns-cloudxns:
            ARCH: arm64
            DNS_PLUGIN: certbot-dns-cloudxns
          arm64-certbot-dns-digitalocean:
            ARCH: arm64
            DNS_PLUGIN: certbot-dns-digitalocean
          arm64-certbot-dns-dnsimple:
            ARCH: arm64
            DNS_PLUGIN: certbot-dns-dnsimple
          arm64-certbot-dns-dnsmadeeasy:
            ARCH: arm64
            DNS_PLUGIN: certbot-dns-dnsmadeeasy
          arm64-certbot-dns-gehirn:
            ARCH: arm64
            DNS_PLUGIN: certbot-dns-gehirn
          arm64-certbot-dns-google:
            ARCH: arm64
            DNS_PLUGIN: certbot-dns-google
          arm64-certbot-dns-linode:
            ARCH: arm64
            DNS_PLUGIN: certbot-dns-linode
          arm64-certbot-dns-luadns:
            ARCH: arm64
            DNS_PLUGIN: certbot-dns-luadns
          arm64-certbot-dns-nsone:
            ARCH: arm64
            DNS_PLUGIN: certbot-dns-nsone
          arm64-certbot-dns-ovh:
            ARCH: arm64
            DNS_PLUGIN: certbot-dns-ovh
          arm64-certbot-dns-rfc2136:
            ARCH: arm64
            DNS_PLUGIN: certbot-dns-rfc2136
          arm64-certbot-dns-route53:
            ARCH: arm64
            DNS_PLUGIN: certbot-dns-route53
          arm64-certbot-dns-sakuracloud:
            ARCH: arm64
            DNS_PLUGIN: certbot-dns-sakuracloud
          armhf-certbot-dns-cloudflare:
            ARCH: armhf
            DNS_PLUGIN: certbot-dns-cloudflare
          armhf-certbot-dns-cloudxns:
            ARCH: armhf
            DNS_PLUGIN: certbot-dns-cloudxns
          armhf-certbot-dns-digitalocean:
            ARCH: armhf
            DNS_PLUGIN: certbot-dns-digitalocean
          armhf-certbot-dns-dnsimple:
            ARCH: armhf
            DNS_PLUGIN: certbot-dns-dnsimple
          armhf-certbot-dns-dnsmadeeasy:
            ARCH: armhf
            DNS_PLUGIN: certbot-dns-dnsmadeeasy
          armhf-certbot-dns-gehirn:
            ARCH: armhf
            DNS_PLUGIN: certbot-dns-gehirn
          armhf-certbot-dns-google:
            ARCH: armhf
            DNS_PLUGIN: certbot-dns-google
          armhf-certbot-dns-linode:
            ARCH: armhf
            DNS_PLUGIN: certbot-dns-linode
          armhf-certbot-dns-luadns:
            ARCH: armhf
            DNS_PLUGIN: certbot-dns-luadns
          armhf-certbot-dns-nsone:
            ARCH: armhf
            DNS_PLUGIN: certbot-dns-nsone
          armhf-certbot-dns-ovh:
            ARCH: armhf
            DNS_PLUGIN: certbot-dns-ovh
          armhf-certbot-dns-rfc2136:
            ARCH: armhf
            DNS_PLUGIN: certbot-dns-rfc2136
          armhf-certbot-dns-route53:
            ARCH: armhf
            DNS_PLUGIN: certbot-dns-route53
          armhf-certbot-dns-sakuracloud:
            ARCH: armhf
            DNS_PLUGIN: certbot-dns-sakuracloud
    pool:
      vmImage: ubuntu-18.04
    steps:
      - script: |
          tools/snap/build_dns.sh ${ARCH} ${DNS_PLUGIN}
          mv certbot-dns-*/*.snap $(Build.ArtifactStagingDirectory)
        displayName: Build Certbot DNS snaps
      - task: PublishPipelineArtifact@1
        inputs:
          path: $(Build.ArtifactStagingDirectory)
          artifact: dns-snap-$(arch)
        displayName: Store snaps artifacts
  - job: snap_run
    dependsOn: snap_build
    pool:
      vmImage: ubuntu-18.04
    steps:
      - script: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends nginx-light snapd
          python tools/pip_install.py -U tox
        displayName: Install dependencies
      - task: DownloadPipelineArtifact@2
        inputs:
          artifact: snap-amd64
          path: $(Build.SourcesDirectory)/snap
        displayName: Retrieve Certbot snap
      - script: |
          sudo snap install --dangerous --classic snap/*.snap
        displayName: Install Certbot snap
      - script: |
          python -m tox -e integration-external,apacheconftest-external-with-pebble
        displayName: Run tox
  - job: snap_dns_run
    dependsOn:
      - snap_build
      - snap_dns_build
    pool:
      vmImage: ubuntu-18.04
    steps:
      - script: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends snapd
        displayName: Install dependencies
      - task: UsePythonVersion@0
        inputs:
          versionSpec: 3.8
          addToPath: true
      - task: DownloadPipelineArtifact@2
        inputs:
          artifact: snap-amd64
          path: $(Build.SourcesDirectory)/snap
        displayName: Retrieve Certbot snap
      - task: DownloadPipelineArtifact@2
        inputs:
          artifact: dns-snap-amd64
          path: $(Build.SourcesDirectory)/snap
        displayName: Retrieve Certbot DNS plugins snaps
      - script: |
          python3 -m venv venv
          venv/bin/python tools/pip_install.py -e certbot-ci
        displayName: Prepare Certbot-CI
      - script: |
          sudo -E venv/bin/pytest certbot-ci/snap_integration_tests/dns_tests --allow-persistent-changes --snap-folder $(Build.SourcesDirectory)/snap
        displayName: Test DNS plugins snaps
