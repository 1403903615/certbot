#!/bin/sh -e

# get certbot version
if [ ! -f "$SNAP/certbot-shared/__init__.py" ]; then
  echo "No certbot version available; not doing version comparison check" >> "$SNAP_DATA/debuglog"
  exit 0
fi

cb_installed=$(grep -oP "__version__ = '\K.*(?=')" $SNAP/certbot-shared/__init__.py)
echo "cb_installed: $cb_installed" >> "$SNAP_DATA/debuglog" # if we succeed
echo "cb_installed: $cb_installed" # if we fail

# get required certbot version for plugin
cb_required=$(grep -oP "certbot>=\K.*(?=')" $SNAP/setup.py)
echo "cb_required: $cb_required" >> "$SNAP_DATA/debuglog"
echo "cb_required: $cb_required"

python3 -c "from distutils.version import LooseVersion; exit(1) if LooseVersion('$cb_installed')\
  < LooseVersion('$cb_required') else exit(0)" || exit_code=$?

if [ "$exit_code" -eq 1 ]; then
  echo "Certbot is version $cb_installed but needs to be at least $cb_required before" \
    "this plugin can be updated; will try again on next refresh."
  exit 1
fi
